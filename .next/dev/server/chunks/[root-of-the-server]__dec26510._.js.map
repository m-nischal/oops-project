{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///Users/nischalreddymuthumula/Desktop/Project%20OOPS%202/src/lib/dbConnect.js"],"sourcesContent":["// lib/dbConnect.js\nimport mongoose from \"mongoose\";\n\n/**\n * @file dbConnect\n * @brief Reusable MongoDB connection util for Next.js API routes.\n *\n * Throws if MONGO_URI missing. Caches connection in global to avoid multiple\n * connections during hot-reload/development.\n */\n\nconst MONGO_URI = process.env.MONGO_URI;\nif (!MONGO_URI) throw new Error(\"MONGO_URI not set\");\n\nlet cached = global._mongoose || { conn: null, promise: null };\nif (!global._mongoose) global._mongoose = cached;\n\n/**\n * Ensure there is a single mongoose connection used across calls.\n * @returns {Promise<mongoose.Mongoose>}\n */\nexport default async function dbConnect() {\n  if (cached.conn) return cached.conn;\n  if (!cached.promise) {\n    // Use the connection string directly; options are managed by mongoose v8 defaults.\n    cached.promise = mongoose.connect(MONGO_URI).then(m => m);\n  }\n  cached.conn = await cached.promise;\n  return cached.conn;\n}\n"],"names":[],"mappings":"AAAA,mBAAmB;;;;;AACnB;;AAEA;;;;;;CAMC,GAED,MAAM,YAAY,QAAQ,GAAG,CAAC,SAAS;AACvC,IAAI,CAAC,WAAW,MAAM,IAAI,MAAM;AAEhC,IAAI,SAAS,yDAAO,SAAS,IAAI;IAAE,MAAM;IAAM,SAAS;AAAK;AAC7D,IAAI,CAAC,yDAAO,SAAS,EAAE,yDAAO,SAAS,GAAG;AAM3B,eAAe;IAC5B,IAAI,OAAO,IAAI,EAAE,OAAO,OAAO,IAAI;IACnC,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,mFAAmF;QACnF,OAAO,OAAO,GAAG,oHAAQ,CAAC,OAAO,CAAC,WAAW,IAAI,CAAC,CAAA,IAAK;IACzD;IACA,OAAO,IAAI,GAAG,MAAM,OAAO,OAAO;IAClC,OAAO,OAAO,IAAI;AACpB","debugId":null}},
    {"offset": {"line": 55, "column": 0}, "map": {"version":3,"sources":["file:///Users/nischalreddymuthumula/Desktop/Project%20OOPS%202/src/models/Product.js"],"sourcesContent":["// src/models/Product.js\nimport mongoose from \"mongoose\";\n\nconst { Schema } = mongoose;\n\n/* --- (all your existing sub-schemas) --- */\nconst ReviewSchema = new Schema({\n  rating: { type: Number, required: true, min: 1, max: 5 },\n  comment: { type: String, default: \"\" },\n  author: { type: String },\n  createdAt: { type: Date, default: Date.now },\n});\n\nconst SizeVariantSchema = new Schema({\n  size: { type: String, required: true },\n  sku: { type: String },\n  stock: { type: Number, default: 0 },\n  price: { type: Number },\n});\n\nconst SizeChartSchema = new Schema({\n  chartName: { type: String },\n  data: { type: Schema.Types.Mixed },\n  image: { type: String }\n}, { _id: false });\n\nconst WarehouseSchema = new Schema({\n  name: { type: String },\n  address: { type: String },\n  city: { type: String },\n  state: { type: String },\n  country: { type: String },\n  pincode: { type: String },\n  leadTimeDays: { type: Number, default: 2 },\n  location: {\n    type: { type: String, enum: ['Point'], default: 'Point' },\n    coordinates: { type: [Number], default: undefined },\n  },\n}, { _id: false });\n\nconst ProductDetailsSchema = new Schema({\n  materialComposition: { type: String },\n  sleeveType: { type: String },\n  materialType: { type: String },\n  fitType: { type: String },\n  length: { type: String },\n  neckStyle: { type: String },\n  countryOfOrigin: { type: String },\n  extras: { type: Schema.Types.Mixed },\n  \n}, { _id: false });\n\n/* --- Main Product Schema --- */\nconst ProductSchema = new Schema({\n  \n  // --- NEW FIELD ---\n  // Tracks who owns this product document (Retailer or Wholesaler).\n  // This will point to your 'User' model.\n  ownerId: {\n    type: Schema.Types.ObjectId,\n    ref: 'User',\n    required: true, // We will make this required\n    index: true\n  },\n\n  // --- NEW FIELD ---\n  // If this is a Retail Listing (ownerId is a Retailer),\n  // this field links back to the Wholesaler's original \"Base Product\".\n  wholesaleSourceId: {\n    type: Schema.Types.ObjectId,\n    ref: 'Product', // This points to another Product document\n    default: null,\n    index: true\n  },\n\n  /* --- Existing Fields --- */\n  name: { type: String, required: true, index: true },\n  slug: { type: String, index: true },\n  description: { type: String },\n  brand: { type: String },\n  retailer: { type: String }, // This field is now technically redundant, but we'll leave it.\n  category: { type: String },\n  price: { type: Number, required: true },\n  images: [{ type: String }],\n  sizes: [SizeVariantSchema],\n  sizeChart: SizeChartSchema,\n  productDetails: ProductDetailsSchema,\n  reviews: [ReviewSchema],\n  warehouses: [WarehouseSchema],\n  totalStock: { type: Number, default: 0 },\n  tags: [String],\n  createdAt: { type: Date, default: Date.now },\n  updatedAt: { type: Date, default: Date.now },\n  isPublished: { type: Boolean, default: false, index: true },\n}, { timestamps: true });\n\n/* --- Existing Methods & Statics --- */\n\n/**\n * helper to recalc totalStock (instance method)\n */\nProductSchema.methods.recalculateStock = function () {\n  const sizeStock = (this.sizes || []).reduce((acc, s) => acc + (s.stock || 0), 0);\n  this.totalStock = sizeStock;\n  return this.totalStock;\n};\n\n/**\n * get best delivery estimate\n */\nProductSchema.methods.estimateDeliveryTo = function (customerLocation = {}) {\n  // ... (your existing method logic) ...\n  const whs = this.warehouses || [];\n  if (!whs.length) return { estimatedDays: null, reason: \"no warehouses configured\" };\n\n  const byPincode = whs.find(w => w.pincode && customerLocation.pincode && w.pincode === customerLocation.pincode);\n  if (byPincode) {\n    return { estimatedDays: byPincode.leadTimeDays, warehouse: byPincode, method: \"pincode-match\" };\n  }\n  // ... (rest of your logic) ...\n  const byCity = whs.find(w => w.city && customerLocation.city && w.city.toLowerCase() === customerLocation.city.toLowerCase());\n  if (byCity) {\n    return { estimatedDays: byCity.leadTimeDays + 1, warehouse: byCity, method: \"city-match\" };\n  }\n  \n  const byState = whs.find(w => w.state && customerLocation.state && w.state.toLowerCase() === customerLocation.state.toLowerCase());\n  if (byState) {\n    return { estimatedDays: byState.leadTimeDays + 2, warehouse: byState, method: \"state-match\" };\n  }\n\n  const minWh = whs.reduce((min, w) => (!min || (w.leadTimeDays < min.leadTimeDays) ? w : min), null);\n  return { estimatedDays: (minWh ? minWh.leadTimeDays + 4 : null), warehouse: minWh, method: \"fallback\" };\n};\n\n/**\n * STATIC HELPER: computeTotalStockForPlainObject\n */\nProductSchema.statics.computeTotalStockForPlainObject = function (productPlain = {}) {\n  // ... (your existing static logic) ...\n  if (!productPlain) return 0;\n  if (typeof productPlain.totalStock === \"number\" && Array.isArray(productPlain.sizes) === false) {\n    return productPlain.totalStock;\n  }\n  if (Array.isArray(productPlain.sizes)) {\n    return productPlain.sizes.reduce((acc, s) => {\n      const n = s && (typeof s.stock === \"number\" ? s.stock : Number(s?.qty ?? 0));\n      return acc + (Number.isFinite(n) ? n : 0);\n    }, 0);\n  }\n  if (typeof productPlain.stock === \"number\") return productPlain.stock;\n  return 0;\n};\n\n/**\n * OPTIONAL STATIC HELPER: recalculateAndPersist\n */\nProductSchema.statics.recalculateAndPersist = async function (productId) {\n  // ... (your existing static logic) ...\n  if (!productId) throw new Error(\"productId required\");\n  const Product = this;\n  const doc = await Product.findById(productId);\n  if (!doc) throw new Error(\"product not found\");\n  doc.recalculateStock();\n  await doc.save();\n  return doc.totalStock;\n};\n\nexport default mongoose.models.Product || mongoose.model(\"Product\", ProductSchema);"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 345, "column": 0}, "map": {"version":3,"sources":["file:///Users/nischalreddymuthumula/Desktop/Project%20OOPS%202/src/models/User.js"],"sourcesContent":["// src/models/User.js\nimport mongoose from \"mongoose\";\n\nconst { Schema } = mongoose; // Destructure Schema for use in sub-schema\n\n// --- UPDATED SUB-SCHEMA: Address (Updated for Geo-location and full name) ---\nconst addressSchema = new Schema({\n  label: { type: String, default: \"Home\" }, \n  firstName: { type: String }, // NEW\n  lastName: { type: String }, // NEW\n  addressLine1: { type: String, required: true }, // Main street address from Google\n  addressLine2: { type: String }, // NEW: For apartment, suite, etc.\n  city: { type: String, required: true },\n  state: { type: String },\n  pincode: { type: String }, \n  country: { type: String, required: true }, // NEW\n  phone: { type: String }, \n  countryCode: { type: String, default: \"+91\" }, // NEW\n  // NEW: GeoJSON structure for map display and future distance queries\n  location: {\n    type: { type: String, enum: ['Point'], default: 'Point' },\n    coordinates: { type: [Number], default: undefined }, // [longitude, latitude]\n  },\n}, { _id: true });\n// --- END UPDATED SUB-SCHEMA ---\n\nconst userSchema = new mongoose.Schema({\n  name: { type: String },\n  email: { type: String, index: true, sparse: true, unique: true },\n  password: { type: String, select: false },\n  oauthProvider: String,\n  oauthId: String,\n  phone: { type: String },\n  role: { type: String, enum: [\"CUSTOMER\",\"RETAILER\",\"WHOLESALER\"], default: \"CUSTOMER\" },\n  verified: { type: Boolean, default: false },\n  otp: {\n    code: String,\n    expiresAt: Date\n  },\n  resetOtp: { type: String },\n  resetOtpExpiry: { type: Number },\n  resetAttempts: { type: Number },\n  addresses: [addressSchema]\n}, { timestamps: true });\n\nexport default mongoose.models.User || mongoose.model(\"User\", userSchema);"],"names":[],"mappings":"AAAA,qBAAqB;;;;;AACrB;;AAEA,MAAM,EAAE,MAAM,EAAE,GAAG,oHAAQ,EAAE,2CAA2C;AAExE,+EAA+E;AAC/E,MAAM,gBAAgB,IAAI,OAAO;IAC/B,OAAO;QAAE,MAAM;QAAQ,SAAS;IAAO;IACvC,WAAW;QAAE,MAAM;IAAO;IAC1B,UAAU;QAAE,MAAM;IAAO;IACzB,cAAc;QAAE,MAAM;QAAQ,UAAU;IAAK;IAC7C,cAAc;QAAE,MAAM;IAAO;IAC7B,MAAM;QAAE,MAAM;QAAQ,UAAU;IAAK;IACrC,OAAO;QAAE,MAAM;IAAO;IACtB,SAAS;QAAE,MAAM;IAAO;IACxB,SAAS;QAAE,MAAM;QAAQ,UAAU;IAAK;IACxC,OAAO;QAAE,MAAM;IAAO;IACtB,aAAa;QAAE,MAAM;QAAQ,SAAS;IAAM;IAC5C,qEAAqE;IACrE,UAAU;QACR,MAAM;YAAE,MAAM;YAAQ,MAAM;gBAAC;aAAQ;YAAE,SAAS;QAAQ;QACxD,aAAa;YAAE,MAAM;gBAAC;aAAO;YAAE,SAAS;QAAU;IACpD;AACF,GAAG;IAAE,KAAK;AAAK;AACf,iCAAiC;AAEjC,MAAM,aAAa,IAAI,oHAAQ,CAAC,MAAM,CAAC;IACrC,MAAM;QAAE,MAAM;IAAO;IACrB,OAAO;QAAE,MAAM;QAAQ,OAAO;QAAM,QAAQ;QAAM,QAAQ;IAAK;IAC/D,UAAU;QAAE,MAAM;QAAQ,QAAQ;IAAM;IACxC,eAAe;IACf,SAAS;IACT,OAAO;QAAE,MAAM;IAAO;IACtB,MAAM;QAAE,MAAM;QAAQ,MAAM;YAAC;YAAW;YAAW;SAAa;QAAE,SAAS;IAAW;IACtF,UAAU;QAAE,MAAM;QAAS,SAAS;IAAM;IAC1C,KAAK;QACH,MAAM;QACN,WAAW;IACb;IACA,UAAU;QAAE,MAAM;IAAO;IACzB,gBAAgB;QAAE,MAAM;IAAO;IAC/B,eAAe;QAAE,MAAM;IAAO;IAC9B,WAAW;QAAC;KAAc;AAC5B,GAAG;IAAE,YAAY;AAAK;uCAEP,oHAAQ,CAAC,MAAM,CAAC,IAAI,IAAI,oHAAQ,CAAC,KAAK,CAAC,QAAQ","debugId":null}},
    {"offset": {"line": 475, "column": 0}, "map": {"version":3,"sources":["file:///Users/nischalreddymuthumula/Desktop/Project%20OOPS%202/src/lib/auth.js"],"sourcesContent":["import jwt from \"jsonwebtoken\";\n\nexport function verifyToken(req) {\n  const auth = req.headers.authorization;\n  if (!auth) throw new Error(\"No token\");\n  const token = auth.split(\" \")[1];\n  return jwt.verify(token, process.env.JWT_SECRET);\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEO,SAAS,YAAY,GAAG;IAC7B,MAAM,OAAO,IAAI,OAAO,CAAC,aAAa;IACtC,IAAI,CAAC,MAAM,MAAM,IAAI,MAAM;IAC3B,MAAM,QAAQ,KAAK,KAAK,CAAC,IAAI,CAAC,EAAE;IAChC,OAAO,4HAAG,CAAC,MAAM,CAAC,OAAO,QAAQ,GAAG,CAAC,UAAU;AACjD","debugId":null}},
    {"offset": {"line": 491, "column": 0}, "map": {"version":3,"sources":["file:///Users/nischalreddymuthumula/Desktop/Project%20OOPS%202/src/pages/api/retailer/wholesale-products.js"],"sourcesContent":["// src/pages/api/retailer/wholesale-products.js\r\nimport dbConnect from \"../../../lib/dbConnect\";\r\nimport Product from \"../../../models/Product\"; //\r\nimport User from \"../../../models/User\";       //\r\nimport { verifyToken } from \"../../../lib/auth\";   //\r\nimport mongoose from \"mongoose\";\r\n\r\nexport default async function handler(req, res) {\r\n  await dbConnect(); //\r\n\r\n  if (req.method !== \"GET\") {\r\n    res.setHeader(\"Allow\", [\"GET\"]);\r\n    return res.status(405).end(`Method ${req.method} Not Allowed`);\r\n  }\r\n\r\n  // --- 1. Real Authentication ---\r\n  // Only a Retailer can browse wholesaler products\r\n  let payload;\r\n  try {\r\n    payload = verifyToken(req); //\r\n    if (!payload || payload.role !== \"RETAILER\") {\r\n      return res.status(401).json({ error: \"Unauthorized. You must be a Retailer.\" });\r\n    }\r\n  } catch (err) {\r\n    return res.status(401).json({ error: \"Unauthorized. Invalid token.\" });\r\n  }\r\n\r\n  // --- 2. Fetch All Wholesaler Products ---\r\n  try {\r\n    const { page = 1, limit = 10, q = \"\" } = req.query;\r\n\r\n    // First, find all User IDs that are Wholesalers\r\n    const wholesalers = await User.find({ role: \"WHOLESALER\" }).select(\"_id\").lean(); //\r\n    const wholesalerIds = wholesalers.map(w => w._id);\r\n\r\n    if (wholesalerIds.length === 0) {\r\n      // No wholesalers exist, so no products can be found\r\n      return res.status(200).json({ items: [], total: 0, page: 1, limit: Number(limit) });\r\n    }\r\n\r\n    // Now, find all products owned by any of these Wholesalers\r\n    const filter = {\r\n      ownerId: { $in: wholesalerIds }, //\r\n    };\r\n    \r\n    if (q) {\r\n      filter.name = { $regex: q, $options: \"i\" };\r\n    }\r\n\r\n    const products = await Product.find(filter)\r\n      .skip((Number(page) - 1) * Number(limit))\r\n      .limit(Number(limit))\r\n      .sort({ createdAt: -1 })\r\n      .lean();\r\n      \r\n    const total = await Product.countDocuments(filter);\r\n\r\n    return res.status(200).json({ \r\n      items: products, \r\n      total,\r\n      page: Number(page),\r\n      limit: Number(limit),\r\n    });\r\n\r\n  } catch (err) {\r\n    console.error(err);\r\n    return res.status(500).json({ error: \"Failed to fetch wholesale products\" });\r\n  }\r\n}"],"names":[],"mappings":"AAAA,+CAA+C;;;;;AAC/C;AACA,uMAA+C,EAAE;AACjD,iMAA+C,EAAE;AACjD,2LAAmD,EAAE;AACrD;;;;;;AAEe,eAAe,QAAQ,GAAG,EAAE,GAAG;IAC5C,MAAM,IAAA,2HAAS,KAAI,EAAE;IAErB,IAAI,IAAI,MAAM,KAAK,OAAO;QACxB,IAAI,SAAS,CAAC,SAAS;YAAC;SAAM;QAC9B,OAAO,IAAI,MAAM,CAAC,KAAK,GAAG,CAAC,CAAC,OAAO,EAAE,IAAI,MAAM,CAAC,YAAY,CAAC;IAC/D;IAEA,iCAAiC;IACjC,iDAAiD;IACjD,IAAI;IACJ,IAAI;QACF,UAAU,IAAA,0HAAW,EAAC,MAAM,EAAE;QAC9B,IAAI,CAAC,WAAW,QAAQ,IAAI,KAAK,YAAY;YAC3C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAwC;QAC/E;IACF,EAAE,OAAO,KAAK;QACZ,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA+B;IACtE;IAEA,2CAA2C;IAC3C,IAAI;QACF,MAAM,EAAE,OAAO,CAAC,EAAE,QAAQ,EAAE,EAAE,IAAI,EAAE,EAAE,GAAG,IAAI,KAAK;QAElD,gDAAgD;QAChD,MAAM,cAAc,MAAM,yHAAI,CAAC,IAAI,CAAC;YAAE,MAAM;QAAa,GAAG,MAAM,CAAC,OAAO,IAAI,IAAI,EAAE;QACpF,MAAM,gBAAgB,YAAY,GAAG,CAAC,CAAA,IAAK,EAAE,GAAG;QAEhD,IAAI,cAAc,MAAM,KAAK,GAAG;YAC9B,oDAAoD;YACpD,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO,EAAE;gBAAE,OAAO;gBAAG,MAAM;gBAAG,OAAO,OAAO;YAAO;QACnF;QAEA,2DAA2D;QAC3D,MAAM,SAAS;YACb,SAAS;gBAAE,KAAK;YAAc;QAChC;QAEA,IAAI,GAAG;YACL,OAAO,IAAI,GAAG;gBAAE,QAAQ;gBAAG,UAAU;YAAI;QAC3C;QAEA,MAAM,WAAW,MAAM,4HAAO,CAAC,IAAI,CAAC,QACjC,IAAI,CAAC,CAAC,OAAO,QAAQ,CAAC,IAAI,OAAO,QACjC,KAAK,CAAC,OAAO,QACb,IAAI,CAAC;YAAE,WAAW,CAAC;QAAE,GACrB,IAAI;QAEP,MAAM,QAAQ,MAAM,4HAAO,CAAC,cAAc,CAAC;QAE3C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAC1B,OAAO;YACP;YACA,MAAM,OAAO;YACb,OAAO,OAAO;QAChB;IAEF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC;QACd,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAqC;IAC5E;AACF","debugId":null}}]
}