{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///C:/SEM-3/OOPS/Project%20OOPS/Project%20OOPS/src/lib/dbConnect.js"],"sourcesContent":["// lib/dbConnect.js\nimport mongoose from \"mongoose\";\n\n/**\n * @file dbConnect\n * @brief Reusable MongoDB connection util for Next.js API routes.\n *\n * Throws if MONGO_URI missing. Caches connection in global to avoid multiple\n * connections during hot-reload/development.\n */\n\nconst MONGO_URI = process.env.MONGO_URI;\nif (!MONGO_URI) throw new Error(\"MONGO_URI not set\");\n\nlet cached = global._mongoose || { conn: null, promise: null };\nif (!global._mongoose) global._mongoose = cached;\n\n/**\n * Ensure there is a single mongoose connection used across calls.\n * @returns {Promise<mongoose.Mongoose>}\n */\nexport default async function dbConnect() {\n  if (cached.conn) return cached.conn;\n  if (!cached.promise) {\n    // Use the connection string directly; options are managed by mongoose v8 defaults.\n    cached.promise = mongoose.connect(MONGO_URI).then(m => m);\n  }\n  cached.conn = await cached.promise;\n  return cached.conn;\n}\n"],"names":[],"mappings":"AAAA,mBAAmB;;;;;AACnB;;AAEA;;;;;;CAMC,GAED,MAAM,YAAY,QAAQ,GAAG,CAAC,SAAS;AACvC,IAAI,CAAC,WAAW,MAAM,IAAI,MAAM;AAEhC,IAAI,SAAS,yDAAO,SAAS,IAAI;IAAE,MAAM;IAAM,SAAS;AAAK;AAC7D,IAAI,CAAC,yDAAO,SAAS,EAAE,yDAAO,SAAS,GAAG;AAM3B,eAAe;IAC5B,IAAI,OAAO,IAAI,EAAE,OAAO,OAAO,IAAI;IACnC,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,mFAAmF;QACnF,OAAO,OAAO,GAAG,oHAAQ,CAAC,OAAO,CAAC,WAAW,IAAI,CAAC,CAAA,IAAK;IACzD;IACA,OAAO,IAAI,GAAG,MAAM,OAAO,OAAO;IAClC,OAAO,OAAO,IAAI;AACpB","debugId":null}},
    {"offset": {"line": 55, "column": 0}, "map": {"version":3,"sources":["file:///C:/SEM-3/OOPS/Project%20OOPS/Project%20OOPS/src/models/User.js"],"sourcesContent":["// src/models/User.js\nimport mongoose from \"mongoose\";\n\nconst userSchema = new mongoose.Schema({\n  name: { type: String },\n  email: { type: String, index: true, sparse: true, unique: false },\n  phone: { type: String, index: true, sparse: true, unique: false },\n  password: { type: String }, // hashed password (bcrypt)\n  oauthProvider: String,\n  oauthId: String,\n  role: { type: String, enum: [\"CUSTOMER\",\"RETAILER\",\"WHOLESALER\"], default: \"CUSTOMER\" },\n  verified: { type: Boolean, default: false },\n  otp: {\n    code: String,\n    expiresAt: Date\n  }\n}, { timestamps: true });\n\nexport default mongoose.models.User || mongoose.model(\"User\", userSchema);\n"],"names":[],"mappings":"AAAA,qBAAqB;;;;;AACrB;;AAEA,MAAM,aAAa,IAAI,oHAAQ,CAAC,MAAM,CAAC;IACrC,MAAM;QAAE,MAAM;IAAO;IACrB,OAAO;QAAE,MAAM;QAAQ,OAAO;QAAM,QAAQ;QAAM,QAAQ;IAAM;IAChE,OAAO;QAAE,MAAM;QAAQ,OAAO;QAAM,QAAQ;QAAM,QAAQ;IAAM;IAChE,UAAU;QAAE,MAAM;IAAO;IACzB,eAAe;IACf,SAAS;IACT,MAAM;QAAE,MAAM;QAAQ,MAAM;YAAC;YAAW;YAAW;SAAa;QAAE,SAAS;IAAW;IACtF,UAAU;QAAE,MAAM;QAAS,SAAS;IAAM;IAC1C,KAAK;QACH,MAAM;QACN,WAAW;IACb;AACF,GAAG;IAAE,YAAY;AAAK;uCAEP,oHAAQ,CAAC,MAAM,CAAC,IAAI,IAAI,oHAAQ,CAAC,KAAK,CAAC,QAAQ","debugId":null}},
    {"offset": {"line": 114, "column": 0}, "map": {"version":3,"sources":["file:///C:/SEM-3/OOPS/Project%20OOPS/Project%20OOPS/src/pages/api/auth/otp/verify.js"],"sourcesContent":["// src/pages/api/auth/otp/verify.js\nimport dbConnect from \"../../../../lib/dbConnect\";\nimport User from \"../../../../models/User\";\nimport jwt from \"jsonwebtoken\";\n\nexport default async function handler(req, res) {\n  try {\n    await dbConnect();\n\n    if (req.method !== \"POST\") {\n      res.setHeader(\"Allow\", \"POST\");\n      return res.status(405).json({ ok: false, message: \"Method not allowed\" });\n    }\n\n    const { phone, email, code } = req.body || {};\n    if (!code || (!phone && !email)) {\n      return res.status(400).json({ ok: false, message: \"email or phone and code are required\" });\n    }\n\n    const query = phone ? { phone } : { email };\n    const user = await User.findOne(query);\n    if (!user) return res.status(404).json({ ok: false, message: \"User not found\" });\n\n    // validate OTP\n    if (!user.otp || user.otp.code !== code) {\n      return res.status(400).json({ ok: false, message: \"Invalid or expired OTP\" });\n    }\n\n    const now = Date.now();\n    const expiresAt = user.otp.expiresAt ? new Date(user.otp.expiresAt).getTime() : 0;\n    if (now > expiresAt) {\n      return res.status(400).json({ ok: false, message: \"Invalid or expired OTP\" });\n    }\n\n    // mark verified and clear otp\n    user.verified = true;\n    user.otp = undefined;\n    await user.save();\n\n    // ensure JWT secret exists\n    const secret = process.env.JWT_SECRET;\n    if (!secret) {\n      // log for server operators and return 500\n      console.error(\"JWT_SECRET is not set in environment\");\n      return res.status(500).json({ ok: false, message: \"Server misconfiguration\" });\n    }\n\n    // sign token\n    const token = jwt.sign(\n      { id: user._id.toString(), role: user.role },\n      secret,\n      { expiresIn: \"30d\" }\n    );\n\n    // Optionally set HttpOnly cookie (safe default). Frontend can still read the token from the JSON.\n    // Adjust `Secure` and `SameSite` as appropriate for your deployment.\n    const maxAge = 30 * 24 * 60 * 60; // 30 days in seconds\n    const isProd = process.env.NODE_ENV === \"production\";\n    const cookieParts = [\n      `token=${token}`,\n      `HttpOnly`,\n      `Path=/`,\n      `Max-Age=${maxAge}`,\n      isProd ? \"Secure\" : \"\",\n      isProd ? \"SameSite=None\" : \"SameSite=Lax\"\n    ].filter(Boolean).join(\"; \");\n    res.setHeader(\"Set-Cookie\", cookieParts);\n\n    // Return minimal user info\n    return res.json({\n      ok: true,\n      message: \"Verified\",\n      token,\n      user: {\n        id: user._id.toString(),\n        name: user.name || null,\n        email: user.email || null,\n        phone: user.phone || null,\n        role: user.role\n      }\n    });\n  } catch (err) {\n    console.error(\"OTP verify error:\", err);\n    return res.status(500).json({ ok: false, message: \"Internal server error\" });\n  }\n}\n"],"names":[],"mappings":"AAAA,mCAAmC;;;;;AACnC;AACA;AACA;;;;AAEe,eAAe,QAAQ,GAAG,EAAE,GAAG;IAC5C,IAAI;QACF,MAAM,IAAA,2HAAS;QAEf,IAAI,IAAI,MAAM,KAAK,QAAQ;YACzB,IAAI,SAAS,CAAC,SAAS;YACvB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,IAAI;gBAAO,SAAS;YAAqB;QACzE;QAEA,MAAM,EAAE,KAAK,EAAE,KAAK,EAAE,IAAI,EAAE,GAAG,IAAI,IAAI,IAAI,CAAC;QAC5C,IAAI,CAAC,QAAS,CAAC,SAAS,CAAC,OAAQ;YAC/B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,IAAI;gBAAO,SAAS;YAAuC;QAC3F;QAEA,MAAM,QAAQ,QAAQ;YAAE;QAAM,IAAI;YAAE;QAAM;QAC1C,MAAM,OAAO,MAAM,yHAAI,CAAC,OAAO,CAAC;QAChC,IAAI,CAAC,MAAM,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,IAAI;YAAO,SAAS;QAAiB;QAE9E,eAAe;QACf,IAAI,CAAC,KAAK,GAAG,IAAI,KAAK,GAAG,CAAC,IAAI,KAAK,MAAM;YACvC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,IAAI;gBAAO,SAAS;YAAyB;QAC7E;QAEA,MAAM,MAAM,KAAK,GAAG;QACpB,MAAM,YAAY,KAAK,GAAG,CAAC,SAAS,GAAG,IAAI,KAAK,KAAK,GAAG,CAAC,SAAS,EAAE,OAAO,KAAK;QAChF,IAAI,MAAM,WAAW;YACnB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,IAAI;gBAAO,SAAS;YAAyB;QAC7E;QAEA,8BAA8B;QAC9B,KAAK,QAAQ,GAAG;QAChB,KAAK,GAAG,GAAG;QACX,MAAM,KAAK,IAAI;QAEf,2BAA2B;QAC3B,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU;QACrC,IAAI,CAAC,QAAQ;YACX,0CAA0C;YAC1C,QAAQ,KAAK,CAAC;YACd,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,IAAI;gBAAO,SAAS;YAA0B;QAC9E;QAEA,aAAa;QACb,MAAM,QAAQ,4HAAG,CAAC,IAAI,CACpB;YAAE,IAAI,KAAK,GAAG,CAAC,QAAQ;YAAI,MAAM,KAAK,IAAI;QAAC,GAC3C,QACA;YAAE,WAAW;QAAM;QAGrB,kGAAkG;QAClG,qEAAqE;QACrE,MAAM,SAAS,KAAK,KAAK,KAAK,IAAI,qBAAqB;QACvD,MAAM,SAAS,oDAAyB;QACxC,MAAM,cAAc;YAClB,CAAC,MAAM,EAAE,OAAO;YAChB,CAAC,QAAQ,CAAC;YACV,CAAC,MAAM,CAAC;YACR,CAAC,QAAQ,EAAE,QAAQ;YACnB,sCAAS,0BAAW;YACpB,sCAAS,0BAAkB;SAC5B,CAAC,MAAM,CAAC,SAAS,IAAI,CAAC;QACvB,IAAI,SAAS,CAAC,cAAc;QAE5B,2BAA2B;QAC3B,OAAO,IAAI,IAAI,CAAC;YACd,IAAI;YACJ,SAAS;YACT;YACA,MAAM;gBACJ,IAAI,KAAK,GAAG,CAAC,QAAQ;gBACrB,MAAM,KAAK,IAAI,IAAI;gBACnB,OAAO,KAAK,KAAK,IAAI;gBACrB,OAAO,KAAK,KAAK,IAAI;gBACrB,MAAM,KAAK,IAAI;YACjB;QACF;IACF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,qBAAqB;QACnC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,IAAI;YAAO,SAAS;QAAwB;IAC5E;AACF","debugId":null}}]
}