{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/rajag/OneDrive/Desktop/vamsi/oops%20project/livemart-19112025/Project%20OOPS/src/lib/dbConnect.js"],"sourcesContent":["// lib/dbConnect.js\nimport mongoose from \"mongoose\";\n\n/**\n * @file dbConnect\n * @brief Reusable MongoDB connection util for Next.js API routes.\n *\n * Throws if MONGO_URI missing. Caches connection in global to avoid multiple\n * connections during hot-reload/development.\n */\n\nconst MONGO_URI = process.env.MONGO_URI;\nif (!MONGO_URI) throw new Error(\"MONGO_URI not set\");\n\nlet cached = global._mongoose || { conn: null, promise: null };\nif (!global._mongoose) global._mongoose = cached;\n\n/**\n * Ensure there is a single mongoose connection used across calls.\n * @returns {Promise<mongoose.Mongoose>}\n */\nexport default async function dbConnect() {\n  if (cached.conn) return cached.conn;\n  if (!cached.promise) {\n    // Use the connection string directly; options are managed by mongoose v8 defaults.\n    cached.promise = mongoose.connect(MONGO_URI).then(m => m);\n  }\n  cached.conn = await cached.promise;\n  return cached.conn;\n}\n"],"names":[],"mappings":"AAAA,mBAAmB;;;;;AACnB;;AAEA;;;;;;CAMC,GAED,MAAM,YAAY,QAAQ,GAAG,CAAC,SAAS;AACvC,IAAI,CAAC,WAAW,MAAM,IAAI,MAAM;AAEhC,IAAI,SAAS,yDAAO,SAAS,IAAI;IAAE,MAAM;IAAM,SAAS;AAAK;AAC7D,IAAI,CAAC,yDAAO,SAAS,EAAE,yDAAO,SAAS,GAAG;AAM3B,eAAe;IAC5B,IAAI,OAAO,IAAI,EAAE,OAAO,OAAO,IAAI;IACnC,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,mFAAmF;QACnF,OAAO,OAAO,GAAG,oHAAQ,CAAC,OAAO,CAAC,WAAW,IAAI,CAAC,CAAA,IAAK;IACzD;IACA,OAAO,IAAI,GAAG,MAAM,OAAO,OAAO;IAClC,OAAO,OAAO,IAAI;AACpB","debugId":null}},
    {"offset": {"line": 55, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/rajag/OneDrive/Desktop/vamsi/oops%20project/livemart-19112025/Project%20OOPS/src/models/orderModel.js"],"sourcesContent":["// models/orderModel.js\nimport mongoose from \"mongoose\";\n\nconst { Schema } = mongoose;\n\n/**\n * Minimal snapshot item schema used inside Order documents.\n */\nconst orderItemSchema = new Schema({\n  productId: { type: Schema.Types.ObjectId, ref: \"Product\", required: true },\n  name: { type: String, required: true },\n  sizeLabel: { type: String, required: true },\n  qty: { type: Number, required: true, min: 1 },\n  unitPrice: { type: Number, required: true },\n  subtotal: { type: Number, required: true },\n  estimatedDelivery: { type: Date }\n}, { _id: false });\n\n/**\n * Status history entries\n */\nconst statusHistorySchema = new Schema({\n  status: { type: String, required: true },\n  at: { type: Date, default: Date.now },\n  note: { type: String }\n}, { _id: false });\n\nconst orderSchema = new Schema({\n  \n  // --- NEW FIELD ---\n  // Tracks which User (Retailer or Wholesaler) is the seller\n  // responsible for fulfilling this order.\n  sellerId: {\n    type: Schema.Types.ObjectId,\n    ref: 'User',\n    required: true, // Every order must have a seller\n    index: true\n  },\n\n  /* --- Existing Fields --- */\n  customer: {\n    name: { type: String, required: true },\n    email: { type: String },\n    phone: { type: String },\n    address: { type: String },\n    customerLocation: { type: Schema.Types.Mixed }\n  },\n  items: { type: [orderItemSchema], required: true },\n\n  subtotal: { type: Number, required: true },\n  shipping: { type: Number, default: 0 },\n  tax: { type: Number, default: 0 },\n  discount: { type: Number, default: 0 },\n  total: { type: Number, required: true },\n\n  status: {\n    type: String,\n    enum: [\n      \"created\", \"ordered\", \"pending\", \"paid\", \"processing\",\n      \"shipped\", \"out_for_delivery\", \"delivered\", \"cancelled\", \"refunded\"\n    ],\n    default: \"created\"\n  },\n\n  statusHistory: { type: [statusHistorySchema], default: [] },\n  estimatedDelivery: { type: Date },\n  payment: {\n    provider: { type: String },\n    paymentId: { type: String },\n    method: { type: String },\n    paidAt: { type: Date },\n    refundedAt: { type: Date },\n    refundInfo: { type: Schema.Types.Mixed }\n  },\n  fulfillment: {\n    trackingNumber: String,\n    carrier: String,\n    shippedAt: Date,\n    outForDeliveryAt: Date,\n    deliveredAt: Date\n  },\n\n  shippedAt: Date,\n  outForDeliveryAt: Date,\n  deliveredAt: Date,\n\n  userId: { type: Schema.Types.ObjectId, ref: \"User\" }, // This is the Customer's ID\n  meta: { type: Schema.Types.Mixed },\n  archived: { type: Boolean, default: false }\n}, { timestamps: true });\n\n// Useful indexes\norderSchema.index({ userId: 1, createdAt: -1 });\norderSchema.index({ \"customer.email\": 1 });\norderSchema.index({ status: 1, createdAt: -1 });\n\n// --- NEW INDEX ---\n// This will make dashboard queries for orders much faster.\norderSchema.index({ sellerId: 1, status: 1, createdAt: -1 });\n\nexport default mongoose.models.Order || mongoose.model(\"Order\", orderSchema);"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 268, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/rajag/OneDrive/Desktop/vamsi/oops%20project/livemart-19112025/Project%20OOPS/src/lib/auth.js"],"sourcesContent":["import jwt from \"jsonwebtoken\";\n\nexport function verifyToken(req) {\n  const auth = req.headers.authorization;\n  if (!auth) throw new Error(\"No token\");\n  const token = auth.split(\" \")[1];\n  return jwt.verify(token, process.env.JWT_SECRET);\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEO,SAAS,YAAY,GAAG;IAC7B,MAAM,OAAO,IAAI,OAAO,CAAC,aAAa;IACtC,IAAI,CAAC,MAAM,MAAM,IAAI,MAAM;IAC3B,MAAM,QAAQ,KAAK,KAAK,CAAC,IAAI,CAAC,EAAE;IAChC,OAAO,4HAAG,CAAC,MAAM,CAAC,OAAO,QAAQ,GAAG,CAAC,UAAU;AACjD","debugId":null}},
    {"offset": {"line": 284, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/rajag/OneDrive/Desktop/vamsi/oops%20project/livemart-19112025/Project%20OOPS/src/pages/api/retailer/analytics.js"],"sourcesContent":["// src/pages/api/retailer/analytics.js\r\nimport dbConnect from \"../../../lib/dbConnect\";\r\nimport Order from \"../../../models/orderModel\";\r\nimport { verifyToken } from \"../../../lib/auth\"; //\r\nimport mongoose from \"mongoose\";\r\n\r\nexport default async function handler(req, res) {\r\n  await dbConnect();\r\n\r\n  if (req.method !== \"GET\") {\r\n    res.setHeader(\"Allow\", [\"GET\"]);\r\n    return res.status(405).end(`Method ${req.method} Not Allowed`);\r\n  }\r\n\r\n  // --- 1. Real Authentication ---\r\n  let payload;\r\n  try {\r\n    payload = verifyToken(req); //\r\n\r\n    // --- THIS IS THE FIX ---\r\n    // We now check for the 'RETAILER' role\r\n    if (!payload || payload.role !== \"RETAILER\") {\r\n      return res\r\n        .status(401)\r\n        .json({ error: \"Unauthorized. You must be a Retailer.\" }); // Updated error message\r\n    }\r\n    // --- END FIX ---\r\n\r\n  } catch (err) {\r\n    return res.status(401).json({ error: \"Unauthorized. Invalid token.\" });\r\n  }\r\n\r\n  const sellerId = new mongoose.Types.ObjectId(payload.id); // Get the logged-in seller's ID\r\n\r\n  // --- 2. Fetch Dashboard Analytics (Logic is identical) ---\r\n  try {\r\n    const allOrders = await Order.find({ sellerId: sellerId }).lean(); //\r\n\r\n    let totalSales = 0;\r\n    let activeOrders = 0;\r\n    let completedOrders = 0;\r\n\r\n    for (const order of allOrders) {\r\n      if (order.status === \"delivered\") {\r\n        completedOrders++;\r\n        totalSales += order.total || 0;\r\n      } else if (order.status !== \"cancelled\" && order.status !== \"refunded\") {\r\n        activeOrders++;\r\n      }\r\n    }\r\n\r\n    const oneYearAgo = new Date();\r\n    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);\r\n\r\n    const salesData = await Order.aggregate([\r\n      {\r\n        $match: {\r\n          sellerId: sellerId,\r\n          status: \"delivered\",\r\n          createdAt: { $gte: oneYearAgo },\r\n        },\r\n      },\r\n      {\r\n        $group: {\r\n          _id: {\r\n            year: { $year: \"$createdAt\" },\r\n            month: { $month: \"$createdAt\" },\r\n          },\r\n          totalRevenue: { $sum: \"$total\" },\r\n        },\r\n      },\r\n      { $sort: { \"_id.year\": 1, \"_id.month\": 1 } },\r\n    ]);\r\n\r\n    const formattedSalesGraph = salesData.map((item) => ({\r\n      month: `${item._id.year}-${String(item._id.month).padStart(2, \"0\")}`,\r\n      sales: item.totalRevenue,\r\n    }));\r\n\r\n    return res.status(200).json({\r\n      stats: {\r\n        totalSales: totalSales,\r\n        totalOrders: allOrders.length,\r\n        activeOrders: activeOrders,\r\n        completedOrders: completedOrders,\r\n      },\r\n      saleGraph: formattedSalesGraph,\r\n    });\r\n  } catch (err) {\r\n    console.error(\"Failed to fetch analytics:\", err);\r\n    return res.status(500).json({ error: \"Failed to fetch analytics\" });\r\n  }\r\n}"],"names":[],"mappings":"AAAA,sCAAsC;;;;;AACtC;AACA;AACA,yNAAiD,EAAE;AACnD;;;;;AAEe,eAAe,QAAQ,GAAG,EAAE,GAAG;IAC5C,MAAM,IAAA,4IAAS;IAEf,IAAI,IAAI,MAAM,KAAK,OAAO;QACxB,IAAI,SAAS,CAAC,SAAS;YAAC;SAAM;QAC9B,OAAO,IAAI,MAAM,CAAC,KAAK,GAAG,CAAC,CAAC,OAAO,EAAE,IAAI,MAAM,CAAC,YAAY,CAAC;IAC/D;IAEA,iCAAiC;IACjC,IAAI;IACJ,IAAI;QACF,UAAU,IAAA,2IAAW,EAAC,MAAM,EAAE;QAE9B,0BAA0B;QAC1B,uCAAuC;QACvC,IAAI,CAAC,WAAW,QAAQ,IAAI,KAAK,YAAY;YAC3C,OAAO,IACJ,MAAM,CAAC,KACP,IAAI,CAAC;gBAAE,OAAO;YAAwC,IAAI,wBAAwB;QACvF;IACA,kBAAkB;IAEpB,EAAE,OAAO,KAAK;QACZ,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA+B;IACtE;IAEA,MAAM,WAAW,IAAI,oHAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,QAAQ,EAAE,GAAG,gCAAgC;IAE1F,4DAA4D;IAC5D,IAAI;QACF,MAAM,YAAY,MAAM,gJAAK,CAAC,IAAI,CAAC;YAAE,UAAU;QAAS,GAAG,IAAI,IAAI,EAAE;QAErE,IAAI,aAAa;QACjB,IAAI,eAAe;QACnB,IAAI,kBAAkB;QAEtB,KAAK,MAAM,SAAS,UAAW;YAC7B,IAAI,MAAM,MAAM,KAAK,aAAa;gBAChC;gBACA,cAAc,MAAM,KAAK,IAAI;YAC/B,OAAO,IAAI,MAAM,MAAM,KAAK,eAAe,MAAM,MAAM,KAAK,YAAY;gBACtE;YACF;QACF;QAEA,MAAM,aAAa,IAAI;QACvB,WAAW,WAAW,CAAC,WAAW,WAAW,KAAK;QAElD,MAAM,YAAY,MAAM,gJAAK,CAAC,SAAS,CAAC;YACtC;gBACE,QAAQ;oBACN,UAAU;oBACV,QAAQ;oBACR,WAAW;wBAAE,MAAM;oBAAW;gBAChC;YACF;YACA;gBACE,QAAQ;oBACN,KAAK;wBACH,MAAM;4BAAE,OAAO;wBAAa;wBAC5B,OAAO;4BAAE,QAAQ;wBAAa;oBAChC;oBACA,cAAc;wBAAE,MAAM;oBAAS;gBACjC;YACF;YACA;gBAAE,OAAO;oBAAE,YAAY;oBAAG,aAAa;gBAAE;YAAE;SAC5C;QAED,MAAM,sBAAsB,UAAU,GAAG,CAAC,CAAC,OAAS,CAAC;gBACnD,OAAO,GAAG,KAAK,GAAG,CAAC,IAAI,CAAC,CAAC,EAAE,OAAO,KAAK,GAAG,CAAC,KAAK,EAAE,QAAQ,CAAC,GAAG,MAAM;gBACpE,OAAO,KAAK,YAAY;YAC1B,CAAC;QAED,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAC1B,OAAO;gBACL,YAAY;gBACZ,aAAa,UAAU,MAAM;gBAC7B,cAAc;gBACd,iBAAiB;YACnB;YACA,WAAW;QACb;IACF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA4B;IACnE;AACF","debugId":null}}]
}