{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/rajag/OneDrive/Desktop/vamsi/oops%20project/livemart-19112025/Project%20OOPS/src/lib/dbConnect.js"],"sourcesContent":["// lib/dbConnect.js\nimport mongoose from \"mongoose\";\n\n/**\n * @file dbConnect\n * @brief Reusable MongoDB connection util for Next.js API routes.\n *\n * Throws if MONGO_URI missing. Caches connection in global to avoid multiple\n * connections during hot-reload/development.\n */\n\nconst MONGO_URI = process.env.MONGO_URI;\nif (!MONGO_URI) throw new Error(\"MONGO_URI not set\");\n\nlet cached = global._mongoose || { conn: null, promise: null };\nif (!global._mongoose) global._mongoose = cached;\n\n/**\n * Ensure there is a single mongoose connection used across calls.\n * @returns {Promise<mongoose.Mongoose>}\n */\nexport default async function dbConnect() {\n  if (cached.conn) return cached.conn;\n  if (!cached.promise) {\n    // Use the connection string directly; options are managed by mongoose v8 defaults.\n    cached.promise = mongoose.connect(MONGO_URI).then(m => m);\n  }\n  cached.conn = await cached.promise;\n  return cached.conn;\n}\n"],"names":[],"mappings":"AAAA,mBAAmB;;;;;AACnB;;AAEA;;;;;;CAMC,GAED,MAAM,YAAY,QAAQ,GAAG,CAAC,SAAS;AACvC,IAAI,CAAC,WAAW,MAAM,IAAI,MAAM;AAEhC,IAAI,SAAS,yDAAO,SAAS,IAAI;IAAE,MAAM;IAAM,SAAS;AAAK;AAC7D,IAAI,CAAC,yDAAO,SAAS,EAAE,yDAAO,SAAS,GAAG;AAM3B,eAAe;IAC5B,IAAI,OAAO,IAAI,EAAE,OAAO,OAAO,IAAI;IACnC,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,mFAAmF;QACnF,OAAO,OAAO,GAAG,oHAAQ,CAAC,OAAO,CAAC,WAAW,IAAI,CAAC,CAAA,IAAK;IACzD;IACA,OAAO,IAAI,GAAG,MAAM,OAAO,OAAO;IAClC,OAAO,OAAO,IAAI;AACpB","debugId":null}},
    {"offset": {"line": 55, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/rajag/OneDrive/Desktop/vamsi/oops%20project/livemart-19112025/Project%20OOPS/src/models/User.js"],"sourcesContent":["// src/models/User.js\nimport mongoose from \"mongoose\";\n\nconst userSchema = new mongoose.Schema({\n  name: { type: String },\n  email: { type: String, index: true, sparse: true, unique: true },\n  password: { type: String, select: false },\n  oauthProvider: String,\n  oauthId: String,\n  role: { type: String, enum: [\"CUSTOMER\",\"RETAILER\",\"WHOLESALER\"], default: \"CUSTOMER\" },\n  verified: { type: Boolean, default: false },\n  otp: {\n    code: String,\n    expiresAt: Date\n  },\n  resetOtp: { type: String },\n  resetOtpExpiry: { type: Number },\n  resetAttempts: { type: Number }\n}, { timestamps: true });\n\nexport default mongoose.models.User || mongoose.model(\"User\", userSchema);\n"],"names":[],"mappings":"AAAA,qBAAqB;;;;;AACrB;;AAEA,MAAM,aAAa,IAAI,oHAAQ,CAAC,MAAM,CAAC;IACrC,MAAM;QAAE,MAAM;IAAO;IACrB,OAAO;QAAE,MAAM;QAAQ,OAAO;QAAM,QAAQ;QAAM,QAAQ;IAAK;IAC/D,UAAU;QAAE,MAAM;QAAQ,QAAQ;IAAM;IACxC,eAAe;IACf,SAAS;IACT,MAAM;QAAE,MAAM;QAAQ,MAAM;YAAC;YAAW;YAAW;SAAa;QAAE,SAAS;IAAW;IACtF,UAAU;QAAE,MAAM;QAAS,SAAS;IAAM;IAC1C,KAAK;QACH,MAAM;QACN,WAAW;IACb;IACA,UAAU;QAAE,MAAM;IAAO;IACzB,gBAAgB;QAAE,MAAM;IAAO;IAC/B,eAAe;QAAE,MAAM;IAAO;AAChC,GAAG;IAAE,YAAY;AAAK;uCAEP,oHAAQ,CAAC,MAAM,CAAC,IAAI,IAAI,oHAAQ,CAAC,KAAK,CAAC,QAAQ","debugId":null}},
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/rajag/OneDrive/Desktop/vamsi/oops%20project/livemart-19112025/Project%20OOPS/src/pages/api/auth/otp/verify.js"],"sourcesContent":["// pages/api/auth/otp/verify.js\nimport dbConnect from \"../../../../lib/dbConnect\";\nimport User from \"../../../../models/User\";\nimport bcrypt from \"bcryptjs\";\n\nexport default async function handler(req, res) {\n  await dbConnect();\n  if (req.method !== \"POST\") return res.status(405).json({ ok: false, message: \"Method not allowed\" });\n\n  // Accept either `otp` or `code` in request body (some frontends use `code`)\n  const { email } = req.body || {};\n  const providedCode = (req.body && (req.body.otp || req.body.code)) || null;\n\n  if (!email || !providedCode) {\n    return res.status(400).json({ ok: false, message: \"Email and OTP required\" });\n  }\n\n  try {\n    const user = await User.findOne({ email: String(email).toLowerCase() });\n\n    // debug info (remove in production)\n    console.log(\"OTP verify request for:\", email, \"providedCode:\", providedCode);\n\n    if (!user) {\n      return res.status(400).json({ ok: false, message: \"Invalid OTP\" });\n    }\n\n    // Support different storage shapes:\n    // - user.otp.code (object with expiresAt)\n    // - user.resetOtp (string) and user.resetOtpExpiry (number)\n    const storedHash =\n      (user.otp && user.otp.code) ||\n      user.resetOtp ||\n      null;\n\n    const expiresAt =\n      (user.otp && user.otp.expiresAt && new Date(user.otp.expiresAt).getTime()) ||\n      (user.resetOtpExpiry && Number(user.resetOtpExpiry)) ||\n      null;\n\n    console.log(\"Stored hash present:\", !!storedHash, \"expiresAt:\", expiresAt);\n\n    if (!storedHash) {\n      return res.status(400).json({ ok: false, message: \"Invalid OTP\" });\n    }\n\n    // check expiry if present\n    if (expiresAt && Date.now() > Number(expiresAt)) {\n      // clear expired OTP fields (both variants)\n      if (user.otp) user.otp = undefined;\n      user.resetOtp = undefined;\n      user.resetOtpExpiry = undefined;\n      user.resetAttempts = undefined;\n      await user.save();\n      return res.status(400).json({ ok: false, message: \"OTP expired\" });\n    }\n\n    // Compare (storedHash is expected to be bcrypt hash)\n    const matches = await bcrypt.compare(String(providedCode).trim(), storedHash);\n    if (!matches) {\n      // increment attempts optionally\n      user.resetAttempts = (user.resetAttempts || 0) + 1;\n      await user.save();\n      return res.status(400).json({ ok: false, message: \"Invalid OTP\" });\n    }\n\n    // OTP valid â€” consume it and mark user verified\n    user.verified = true;\n    if (user.otp) user.otp = undefined;\n    user.resetOtp = undefined;\n    user.resetOtpExpiry = undefined;\n    user.resetAttempts = undefined;\n\n    await user.save();\n\n    return res.status(200).json({ ok: true, message: \"OTP verified\" });\n  } catch (err) {\n    console.error(\"OTP verify error:\", err && err.stack ? err.stack : err);\n    return res.status(500).json({ ok: false, message: \"Server error\" });\n  }\n}\n"],"names":[],"mappings":"AAAA,+BAA+B;;;;;AAC/B;AACA;AACA;;;;;;;;AAEe,eAAe,QAAQ,GAAG,EAAE,GAAG;IAC5C,MAAM,IAAA,4IAAS;IACf,IAAI,IAAI,MAAM,KAAK,QAAQ,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;QAAE,IAAI;QAAO,SAAS;IAAqB;IAElG,4EAA4E;IAC5E,MAAM,EAAE,KAAK,EAAE,GAAG,IAAI,IAAI,IAAI,CAAC;IAC/B,MAAM,eAAe,AAAC,IAAI,IAAI,IAAI,CAAC,IAAI,IAAI,CAAC,GAAG,IAAI,IAAI,IAAI,CAAC,IAAI,KAAM;IAEtE,IAAI,CAAC,SAAS,CAAC,cAAc;QAC3B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,IAAI;YAAO,SAAS;QAAyB;IAC7E;IAEA,IAAI;QACF,MAAM,OAAO,MAAM,0IAAI,CAAC,OAAO,CAAC;YAAE,OAAO,OAAO,OAAO,WAAW;QAAG;QAErE,oCAAoC;QACpC,QAAQ,GAAG,CAAC,2BAA2B,OAAO,iBAAiB;QAE/D,IAAI,CAAC,MAAM;YACT,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,IAAI;gBAAO,SAAS;YAAc;QAClE;QAEA,oCAAoC;QACpC,0CAA0C;QAC1C,4DAA4D;QAC5D,MAAM,aACJ,AAAC,KAAK,GAAG,IAAI,KAAK,GAAG,CAAC,IAAI,IAC1B,KAAK,QAAQ,IACb;QAEF,MAAM,YACJ,AAAC,KAAK,GAAG,IAAI,KAAK,GAAG,CAAC,SAAS,IAAI,IAAI,KAAK,KAAK,GAAG,CAAC,SAAS,EAAE,OAAO,MACtE,KAAK,cAAc,IAAI,OAAO,KAAK,cAAc,KAClD;QAEF,QAAQ,GAAG,CAAC,wBAAwB,CAAC,CAAC,YAAY,cAAc;QAEhE,IAAI,CAAC,YAAY;YACf,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,IAAI;gBAAO,SAAS;YAAc;QAClE;QAEA,0BAA0B;QAC1B,IAAI,aAAa,KAAK,GAAG,KAAK,OAAO,YAAY;YAC/C,2CAA2C;YAC3C,IAAI,KAAK,GAAG,EAAE,KAAK,GAAG,GAAG;YACzB,KAAK,QAAQ,GAAG;YAChB,KAAK,cAAc,GAAG;YACtB,KAAK,aAAa,GAAG;YACrB,MAAM,KAAK,IAAI;YACf,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,IAAI;gBAAO,SAAS;YAAc;QAClE;QAEA,qDAAqD;QACrD,MAAM,UAAU,MAAM,2HAAM,CAAC,OAAO,CAAC,OAAO,cAAc,IAAI,IAAI;QAClE,IAAI,CAAC,SAAS;YACZ,gCAAgC;YAChC,KAAK,aAAa,GAAG,CAAC,KAAK,aAAa,IAAI,CAAC,IAAI;YACjD,MAAM,KAAK,IAAI;YACf,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,IAAI;gBAAO,SAAS;YAAc;QAClE;QAEA,gDAAgD;QAChD,KAAK,QAAQ,GAAG;QAChB,IAAI,KAAK,GAAG,EAAE,KAAK,GAAG,GAAG;QACzB,KAAK,QAAQ,GAAG;QAChB,KAAK,cAAc,GAAG;QACtB,KAAK,aAAa,GAAG;QAErB,MAAM,KAAK,IAAI;QAEf,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,IAAI;YAAM,SAAS;QAAe;IAClE,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,qBAAqB,OAAO,IAAI,KAAK,GAAG,IAAI,KAAK,GAAG;QAClE,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,IAAI;YAAO,SAAS;QAAe;IACnE;AACF","debugId":null}}]
}